---
title: 5.20 ä¸Šä¸‹æ–‡å‹ç¼©
subtitle: æ™ºèƒ½ç®¡ç†è¶…é•¿å¯¹è¯
course: OpenCode ä¸­æ–‡å®æˆ˜è¯¾
stage: ç¬¬äº”é˜¶æ®µ
lesson: "5.20"
duration: 15 åˆ†é’Ÿ
level: è¿›é˜¶
description: å­¦ä¹ ä¸Šä¸‹æ–‡å‹ç¼©æœºåˆ¶ï¼Œç†è§£ Context ç™¾åˆ†æ¯”è®¡ç®—ï¼ŒæŒæ¡å‹ç¼©å‘½ä»¤å’Œè‡ªåŠ¨è§¦å‘åŸç†ã€‚
tags:
  - ä¸Šä¸‹æ–‡
  - å‹ç¼©
  - æ¨¡å‹é…ç½®
prerequisite:
  - 5.1a é…ç½®åŸºç¡€
  - 2.1 ç•Œé¢ä¸åŸºç¡€æ“ä½œ
---

# 5.20 ä¸Šä¸‹æ–‡å‹ç¼©

## ğŸ“ è¯¾ç¨‹ç¬”è®°

æœ¬è¯¾æ ¸å¿ƒçŸ¥è¯†ç‚¹æ•´ç†ï¼š

<img src="/images/5-advanced/compaction-notes.mini.jpeg" 
     alt="ä¸Šä¸‹æ–‡å‹ç¼©å­¦éœ¸ç¬”è®°" 
     data-zoom-src="/images/5-advanced/compaction-notes.jpeg" />

---

> å½“å¯¹è¯å¤ªé•¿æ—¶ï¼ŒOpenCode ä¼šè‡ªåŠ¨å‹ç¼©å†å²æ¶ˆæ¯ï¼Œè…¾å‡ºç©ºé—´ç»§ç»­å¯¹è¯ã€‚

---

## å­¦å®Œä½ èƒ½åšä»€ä¹ˆ

- ç†è§£ä»€ä¹ˆæ˜¯ä¸Šä¸‹æ–‡å‹ç¼©åŠå…¶å¿…è¦æ€§
- çœ‹æ‡‚ TUI ä¸Šçš„ "Context X% used" åˆ°åº•ä»£è¡¨ä»€ä¹ˆ
- æŒæ¡ `/compact` å‘½ä»¤çš„ä½¿ç”¨æ—¶æœºå’Œæ•ˆæœ
- é…ç½®è‡ªåŠ¨å‹ç¼©è¡Œä¸ºï¼Œæ§åˆ¶ä½•æ—¶è§¦å‘å‹ç¼©
- è‡ªå®šä¹‰æ¨¡å‹çš„ä¸Šä¸‹æ–‡çª—å£å¤§å°

---

## ä½ ç°åœ¨çš„å›°å¢ƒ

- å¯¹è¯è¿›è¡Œåˆ°ä¸€åŠï¼Œçªç„¶æŠ¥é”™ "context overflow"
- ä¸çŸ¥é“ TUI å³ä¾§çš„ "Context 85% used" æ˜¯æ€ä¹ˆç®—å‡ºæ¥çš„
- æƒ³æ‰‹åŠ¨æ¸…ç†å†å²æ¶ˆæ¯ï¼Œä½†æ€•ä¸¢å¤±é‡è¦ä¸Šä¸‹æ–‡
- åŒæ ·çš„æ¨¡å‹ï¼Œä¸ºä»€ä¹ˆåˆ«äººèƒ½ç”¨æ›´é•¿çš„å¯¹è¯ï¼Ÿ

---

## ä»€ä¹ˆæ—¶å€™ç”¨è¿™ä¸€æ‹›

- å½“ä½ éœ€è¦ï¼šé•¿æ—¶é—´ debug æˆ–é‡æ„ï¼Œå¯¹è¯ç§¯ç´¯äº†å¤§é‡å†å²è®°å½•
- è€Œä¸”ä¸æƒ³ï¼šå› ä¸ºä¸Šä¸‹æ–‡è¶…é™è€Œè¢«è¿«é‡å¯å¯¹è¯
- æ¨¡å‹æŠ¥é”™ï¼š`Error: Request too large for context window` æ—¶

---

## æ ¸å¿ƒæ€è·¯

### ä»€ä¹ˆæ˜¯ Context Windowï¼Ÿ

æ¯ä¸ª LLM æ¨¡å‹éƒ½æœ‰ä¸€ä¸ª**ä¸Šä¸‹æ–‡çª—å£ï¼ˆContext Windowï¼‰**ï¼Œé™åˆ¶äº†æ¨¡å‹ä¸€æ¬¡èƒ½"çœ‹åˆ°"çš„æœ€å¤§ token æ•°é‡ã€‚è¶…è¿‡è¿™ä¸ªé™åˆ¶ï¼Œæ¨¡å‹å°±æ— æ³•å¤„ç†æ–°çš„è¯·æ±‚ã€‚

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
- **Context**: ä¸Šä¸‹æ–‡çª—å£æ€»å¤§å°
- **Input tokens**: å‘é€ç»™æ¨¡å‹çš„æ–‡æœ¬ï¼ˆç”¨æˆ·æ¶ˆæ¯ + ç³»ç»Ÿæç¤º + å·¥å…·è°ƒç”¨ç»“æœï¼‰
- **Output tokens**: æ¨¡å‹ç”Ÿæˆçš„å›å¤
- **Cache tokens**: ä½¿ç”¨ Prompt Caching æ—¶ç¼“å­˜çš„ token

### å‹ç¼©åšäº†ä»€ä¹ˆï¼Ÿ

OpenCode çš„å‹ç¼©æœºåˆ¶åŒ…å«ä¸¤ä¸ªåŠ¨ä½œï¼š

1. **Pruneï¼ˆè£å‰ªï¼‰**: è‡ªåŠ¨æ¸…é™¤æ—§çš„å·¥å…·è°ƒç”¨è¾“å‡º
   - ä¿ç•™æœ€è¿‘ 40,000 tokens çš„å·¥å…·è¾“å‡º
   - æ¸…é™¤æ›´æ—©çš„å·¥å…·è¾“å‡ºï¼ˆå¦‚æ–‡ä»¶å†…å®¹ã€æœç´¢ç»“æœï¼‰
   - é¿å…åˆ é™¤ skill ç±»å·¥å…·çš„è¾“å‡ºï¼ˆé€šå¸¸åŒ…å«é‡è¦çŠ¶æ€ï¼‰

2. **Summarizeï¼ˆæ€»ç»“ï¼‰**: ç”¨ LLM ç”Ÿæˆæ‘˜è¦
   - å°†å†å²å¯¹è¯å‘é€ç»™ä¸“é—¨çš„ compaction agent
   - ç”Ÿæˆä¸€ä»½è¯¦ç»†æ‘˜è¦ï¼ŒåŒ…å«ï¼šåšäº†ä»€ä¹ˆã€åœ¨åšä»€ä¹ˆã€ä¸‹ä¸€æ­¥è®¡åˆ’
   - ç”¨æ‘˜è¦æ›¿æ¢åŸå§‹å†å²æ¶ˆæ¯ï¼Œå¤§å¹…å‡å°‘ token å ç”¨

---

## åŸç†æ·±åº¦è§£æ

### Context ç™¾åˆ†æ¯”å¦‚ä½•è®¡ç®—ï¼Ÿ

TUI å³ä¾§æ˜¾ç¤ºçš„ "Context X% used" è®¡ç®—å…¬å¼ï¼š

```
Context ç™¾åˆ†æ¯” = (input + output + reasoning + cache.read + cache.write) / model.limit.context * 100
```

**åŒ…å«çš„ token ç±»å‹**ï¼š
- `input`: è¾“å…¥ç»™æ¨¡å‹çš„ token
- `output`: æ¨¡å‹è¾“å‡ºçš„ token
- `reasoning`: æ¨ç†æ¨¡å‹çš„æ€è€ƒè¿‡ç¨‹ï¼ˆå¦‚ Claude Thinkingï¼‰
- `cache.read`: ä»ç¼“å­˜è¯»å–çš„ token
- `cache.write`: å†™å…¥ç¼“å­˜çš„ token

### è‡ªåŠ¨å‹ç¼©ä»€ä¹ˆæ—¶å€™è§¦å‘ï¼Ÿ

**æ ¸å¿ƒåˆ¤æ–­å‡½æ•°**ï¼ˆæºç ä½ç½®ï¼š`src/session/compaction.ts:32-48`ï¼‰ï¼š

```typescript
è§¦å‘æ¡ä»¶: token_count >= (input_limit - reserved)
å…¶ä¸­ reserved = min(20000, model_max_output)
```

**å…¬å¼è§£è¯»**ï¼š
1. è®¡ç®—å·²ä½¿ç”¨çš„ token æ€»é‡ï¼š`input + output + cache.read + cache.write`
2. è®¡ç®—é¢„ç•™ç©ºé—´ï¼ˆreservedï¼‰ï¼šé»˜è®¤å– `min(20,000, æ¨¡å‹æœ€å¤§è¾“å‡º)` 
3. è®¡ç®—å¯ç”¨ç©ºé—´ï¼š`input_limit - reserved`
4. å½“å·²ä½¿ç”¨é‡ >= å¯ç”¨ç©ºé—´æ—¶ï¼Œè§¦å‘è‡ªåŠ¨å‹ç¼©

**ç¤ºä¾‹è®¡ç®—**ï¼š
- æ¨¡å‹ï¼šClaude Sonnet 4.5ï¼ˆcontext = 200,000, input = 200,000, output = 64,000ï¼‰
- é¢„ç•™ç©ºé—´ = min(20,000, 64,000) = **20,000**
- å¯ç”¨ç©ºé—´ = 200,000 - 20,000 = **180,000**
- å½“ `token_count >= 180,000` æ—¶è§¦å‘å‹ç¼©

**ä¸ºä»€ä¹ˆéœ€è¦ reserve token bufferï¼Ÿ**ï¼ˆv1.1.57 æ”¹è¿›ï¼‰
- ç¡®ä¿ input window æœ‰è¶³å¤Ÿç©ºé—´è¿›è¡Œå‹ç¼©æ“ä½œ
- å‹ç¼©è¿‡ç¨‹æœ¬èº«éœ€è¦å‘é€æ‘˜è¦è¯·æ±‚ï¼Œéœ€è¦é¢„ç•™ç©ºé—´
- å‹ç¼©æ›´åŠ å¯é ï¼Œå‡å°‘"å‹ç¼©å¤±è´¥"çš„æƒ…å†µ

### å‹ç¼©æµç¨‹è¯¦è§£

<AdInArticle />

#### ç¬¬ 1 æ­¥ï¼šPrune å·¥å…·è¾“å‡º
```typescript
// ä¿ç•™æœ€è¿‘ 40K tokens çš„å·¥å…·è¾“å‡º
PRUNE_PROTECT = 40_000
PRUNE_MINIMUM = 20_000
```
- ä»åå¾€å‰éå†æ¶ˆæ¯
- ç´¯ç§¯å·¥å…·è¾“å‡º tokenï¼Œç›´åˆ°è¾¾åˆ° 40,000
- è¶…å‡ºéƒ¨åˆ†çš„å·¥å…·è¾“å‡ºæ ‡è®°ä¸º `compacted`
- å¦‚æœæ¸…ç†é‡ > 20,000ï¼Œæ‰çœŸæ­£æ‰§è¡Œï¼ˆé¿å…å¾®ä¸è¶³é“çš„æ¸…ç†ï¼‰

#### ç¬¬ 2 æ­¥ï¼šè°ƒç”¨ Compaction Agent
- åˆ›å»ºä¸€ä¸ªéšè—çš„ agentï¼ˆåç§°ï¼š`compaction`ï¼‰
- ç¦ç”¨æ‰€æœ‰å·¥å…·æƒé™ï¼ˆ`PermissionNext.fromConfig({ "*": "deny" })`ï¼‰
- å‘é€æ€»ç»“ promptï¼š
  ```
  "Provide a detailed prompt for continuing our conversation above. 
  Focus on information that would be helpful for continuing the conversation, 
  including what we did, what we're doing, which files we're working on, 
  and what we're going to do next considering new session will not have access to our conversation."
  ```

#### ç¬¬ 3 æ­¥ï¼šæ›¿æ¢å†å²æ¶ˆæ¯
- ç”Ÿæˆçš„æ‘˜è¦ä¼šè¢«æ ‡è®°ä¸º `summary: true`
- åŸå§‹å†å²æ¶ˆæ¯è¢«æ›¿æ¢ï¼Œä½†æ‘˜è¦ä¼šå‡ºç°åœ¨å¯¹è¯å†å²ä¸­
- ä¹‹åçš„å¯¹è¯åªä¼šçœ‹åˆ°æ‘˜è¦ï¼Œè€Œä¸æ˜¯å®Œæ•´çš„åŸå§‹æ¶ˆæ¯

---

## ä¸»æµæ¨¡å‹ä¸Šä¸‹æ–‡çª—å£

### æ•°æ®æ¥æº

OpenCode ä» **https://models.dev/api.json** è¿œç¨‹è·å–æœ€æ–°çš„æ¨¡å‹æ•°æ®ï¼ˆæºç ï¼š`src/provider/models.ts`ï¼‰ï¼Œæ¯æ¬¡å¯åŠ¨æ—¶ä¼šæ›´æ–°æœ¬åœ°ç¼“å­˜ã€‚

### å¸¸ç”¨æ¨¡å‹åˆ—è¡¨

| æ¨¡å‹ | Provider | Context | Output | è§¦å‘é˜ˆå€¼* |
|-----|----------|---------|--------|----------|
| Claude Sonnet 4.5 | Anthropic | 200,000 | 64,000 | ~168,000 |
| Claude Opus 4.5 | Anthropic | 200,000 | 64,000 | ~168,000 |
| Gemini 3 Pro | Google | 1,000,000 | 64,000 | ~968,000 |
| Gemini 3 Flash | Google | 1,048,576 | 65,536 | ~1,016,536 |
| GPT 5.2 Pro | OpenAI | 400,000 | 128,000 | ~368,000 |
| GPT 5.2 | OpenAI | 400,000 | 128,000 | ~368,000 |
| GLM 4.7 | ZhipuAI | 204,800 | 131,072 | ~172,728 |
| DeepSeek Chat | DeepSeek | 128,000 | 8,192 | ~119,808 |

> *è§¦å‘é˜ˆå€¼ = context - min(output, 32,000)ï¼Œä»…ä¾›å‚è€ƒï¼Œå®é™…å€¼ä»¥ models.dev ä¸ºå‡†

**å…³é”®å‘ç°**ï¼š
- Gemini 3 Flash æœ‰æœ€å¤§çš„ä¸Šä¸‹æ–‡çª—å£ï¼ˆ~1Mï¼‰ï¼Œé€‚åˆè¶…é•¿æ–‡æ¡£åˆ†æ
- DeepSeek Chat çš„ä¸Šä¸‹æ–‡è¾ƒå°ï¼ˆ128Kï¼‰ï¼Œæ›´å®¹æ˜“è§¦å‘å‹ç¼©
- GPT 5.2 ç³»åˆ—çš„è¾“å‡ºé™åˆ¶å¾ˆå¤§ï¼ˆ128Kï¼‰ï¼Œé¢„ç•™ç©ºé—´å……è¶³

---

## è·Ÿæˆ‘åš

### ç¬¬ 1 æ­¥ï¼šæŸ¥çœ‹å½“å‰ Context ç”¨é‡

åœ¨ TUI å³ä¾§è¾¹æ ï¼Œæ‰¾åˆ° Context åŒºåŸŸï¼š

```
Context
145,234 tokens 73% used
```

è¿™è¡¨ç¤ºå½“å‰å¯¹è¯ä½¿ç”¨äº† 145,234 ä¸ª tokenï¼Œå æ¨¡å‹ä¸Šä¸‹æ–‡çª—å£çš„ 73%ã€‚

**ä½ åº”è¯¥çœ‹åˆ°**ï¼š
- å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ GPT 5.2ï¼ˆcontext = 400,000ï¼‰ï¼Œæ˜¾ç¤ºçš„ç™¾åˆ†æ¯”é€‚ä¸­
- å¦‚æœä½¿ç”¨çš„æ˜¯ Gemini 3 Flashï¼ˆcontext = 1,048,576ï¼‰ï¼Œæ˜¾ç¤ºçš„ç™¾åˆ†æ¯”ä¼šå¾ˆä½

### ç¬¬ 2 æ­¥ï¼šæ‰‹åŠ¨è§¦å‘å‹ç¼©

å½“ä½ è§‰å¾—å¯¹è¯å¤ªé•¿ï¼Œæƒ³æ‰‹åŠ¨å‹ç¼©æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼ï¼š

**æ–¹å¼ 1ï¼šTUI å‘½ä»¤**
åœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥ï¼š
```
/compact
```
æˆ–åˆ«åï¼š
```
/summarize
```

**æ–¹å¼ 2ï¼šå¿«æ·é”®**
æŒ‰ `<leader>c`ï¼ˆé»˜è®¤æ˜¯ `,c`ï¼‰

**ä½ åº”è¯¥çœ‹åˆ°**ï¼š
- è¾“å…¥æ¡†ä¼šå‡ºç° `Compacting...` æç¤º
- æ¨¡å‹ä¼šç”Ÿæˆä¸€ä»½è¯¦ç»†æ‘˜è¦
- å‹ç¼©å®Œæˆåï¼Œå¯¹è¯å†å²ä¼šè¢«æ›¿æ¢ä¸ºæ‘˜è¦å†…å®¹

### ç¬¬ 3 æ­¥ï¼šè§‚å¯Ÿå‹ç¼©æ•ˆæœ

å‹ç¼©å®Œæˆåï¼ŒæŸ¥çœ‹ Context ç™¾åˆ†æ¯”ï¼š

```
Context
45,678 tokens 23% used
```

å¯¹æ¯”å‹ç¼©å‰çš„ 73%ï¼Œä½ ä¼šå‘ç° token ä½¿ç”¨é‡å¤§å¹…ä¸‹é™ã€‚

**ä½ åº”è¯¥çœ‹åˆ°**ï¼š
- æ—§çš„å·¥å…·è°ƒç”¨ç»“æœè¢«æ¸…é™¤ï¼ˆå¦‚æ–‡ä»¶è¯»å–å†…å®¹ï¼‰
- ä¿ç•™äº†ä¸€ä»½è¯¦ç»†çš„å¯¹è¯æ‘˜è¦
- ç»§ç»­å¯¹è¯æ—¶ï¼Œæ¨¡å‹ä¼šåŸºäºæ‘˜è¦ç»§ç»­å·¥ä½œ

---

## æ£€æŸ¥ç‚¹ âœ…

- [ ] ç†è§£ Context ç™¾åˆ†æ¯”çš„è®¡ç®—å…¬å¼
- [ ] èƒ½æ‰‹åŠ¨è§¦å‘ `/compact` å‘½ä»¤
- [ ] å‹ç¼©å Context ç™¾åˆ†æ¯”æ˜æ˜¾ä¸‹é™
- [ ] æ¨¡å‹èƒ½åŸºäºæ‘˜è¦ç»§ç»­å¯¹è¯

---

## é«˜çº§é…ç½®

### é…ç½®æ–‡ä»¶ä½ç½®

OpenCode æ”¯æŒå¤šå±‚çº§é…ç½®ï¼ŒæŒ‰ä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼š

| ä½ç½® | ä¼˜å…ˆçº§ | è¯´æ˜ |
|-----|-------|------|
| `./opencode.json` | é«˜ | é¡¹ç›®çº§é…ç½®ï¼ˆæ¨èç”¨äºé¡¹ç›®ç‰¹å®šè®¾ç½®ï¼‰ |
| `~/.config/opencode/opencode.json` | ä½ | å…¨å±€é…ç½®ï¼ˆæ¨èç”¨äºä¸ªäººåå¥½ï¼‰ |
| `OPENCODE_CONFIG` ç¯å¢ƒå˜é‡ | æœ€é«˜ | è‡ªå®šä¹‰é…ç½®æ–‡ä»¶è·¯å¾„ |
| `OPENCODE_CONFIG_DIR` ç¯å¢ƒå˜é‡ | - | è‡ªå®šä¹‰é…ç½®ç›®å½• |

### é…ç½®é¢„ç•™ç©ºé—´ï¼ˆv1.1.57 æ–°å¢ï¼‰

å‹ç¼©è§¦å‘æ—¶ä¼šé¢„ç•™ä¸€å®šçš„ token ç©ºé—´ï¼Œç¡®ä¿å‹ç¼©æ“ä½œæœ¬èº«èƒ½é¡ºåˆ©è¿›è¡Œï¼š

**opencode.json**
```json
{
  "compaction": {
    "reserved": 30000
  }
}
```

**å‚æ•°è¯´æ˜**ï¼š
- é»˜è®¤å€¼ï¼š`min(20000, æ¨¡å‹æœ€å¤§è¾“å‡º)`
- ä½œç”¨ï¼šæ§åˆ¶ä½•æ—¶è§¦å‘å‹ç¼©ï¼ˆæå‰é‡ï¼‰
- åœºæ™¯ï¼šå¦‚æœå‹ç¼©ç»å¸¸å¤±è´¥ï¼Œå¯ä»¥å¢å¤§æ­¤å€¼

### ç¦ç”¨è‡ªåŠ¨å‹ç¼©

å¦‚æœä½ ä¸æƒ³è®© OpenCode è‡ªåŠ¨å‹ç¼©ï¼Œå¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®ï¼š

**opencode.json**
```json
{
  "compaction": {
    "auto": false
  }
}
```

æˆ–åœ¨å‘½ä»¤è¡Œä¸­ï¼š
```bash
OPENCODE_DISABLE_AUTOCOMPACT=true opencode
```

### ç¦ç”¨å·¥å…·è¾“å‡ºè£å‰ª

Prune åŠŸèƒ½ä¼šè‡ªåŠ¨æ¸…é™¤æ—§çš„å·¥å…·è¾“å‡ºã€‚å¦‚æœä½ æƒ³ä¿ç•™æ‰€æœ‰å·¥å…·è¾“å‡ºï¼š

**opencode.json**
```json
{
  "compaction": {
    "prune": false
  }
}
```

æˆ–åœ¨å‘½ä»¤è¡Œä¸­ï¼š
```bash
OPENCODE_DISABLE_PRUNE=true opencode
```

### è‡ªå®šä¹‰æ¨¡å‹ä¸Šä¸‹æ–‡é™åˆ¶

å¦‚æœä½ æƒ³ä¿®æ”¹æŸä¸ªæ¨¡å‹çš„ context æˆ– output é™åˆ¶ï¼ˆä¾‹å¦‚ï¼Œæƒ³æå‰è§¦å‘å‹ç¼©ï¼‰ï¼š

**opencode.json**
```json
{
  "provider": {
    "openai": {
      "models": {
        "gpt-5.2": {
          "limit": {
            "context": 100000,
            "output": 10000
          }
        }
      }
    }
  }
}
```

**ç¤ºä¾‹åœºæ™¯**ï¼š
- åŸå§‹ GPT 5.2: context = 400,000ï¼Œè§¦å‘é˜ˆå€¼ ~368,000
- è‡ªå®šä¹‰å: context = 100,000ï¼Œè§¦å‘é˜ˆå€¼ ~90,000
- æ•ˆæœï¼šåœ¨å¯¹è¯æ›´æ—©æœŸå°±è§¦å‘å‹ç¼©ï¼Œé¿å…è¶…é™

**ä¸ºä»€ä¹ˆè¿™æ ·åšï¼Ÿ**
- æŸäº›æ¨¡å‹åœ¨é«˜ context ä½¿ç”¨ç‡æ—¶æ€§èƒ½ä¸‹é™
- ä½ å¸Œæœ›æ›´æ—©å‹ç¼©ï¼Œä¿ç•™æ›´å¤šç”Ÿæˆç©ºé—´
- èŠ‚çœ API æˆæœ¬ï¼ˆæ›´å°‘çš„ token è¾“å…¥ï¼‰

---

## è¸©å‘æé†’

| ç°è±¡ | åŸå›  | è§£å†³ |
|-----|-----|-----|
| å‹ç¼©åæ¨¡å‹è®°ä¸ä½ç»†èŠ‚ | å‹ç¼©æ‘˜è¦ä¸¢å¤±äº†å…³é”®ä¿¡æ¯ | æ‰‹åŠ¨è¡¥å……å…³é”®ä¿¡æ¯ï¼Œæˆ–é‡å¯å¯¹è¯ |
| å‹ç¼©äº†è¿˜æ˜¯è¶…é™ | æ¨¡å‹è¾“å‡ºå¤ªé•¿ï¼Œè¶…è¿‡é¢„ç•™ç©ºé—´ | å‡å°‘ max_tokensï¼Œæˆ–æ¢ context æ›´å¤§çš„æ¨¡å‹ |
| Context ç™¾åˆ†æ¯”æ˜¾ç¤ºä¸æ­£ç¡® | models.dev æ•°æ®è¿‡æœŸï¼Œæœ¬åœ°ç¼“å­˜æœªæ›´æ–° | åˆ é™¤ç¼“å­˜ï¼Œé‡å¯ OpenCode |
| ä¸æƒ³ç”¨å‹ç¼© | ç¦ç”¨äº†è‡ªåŠ¨å‹ç¼©ï¼Œä½†è¿˜æ˜¯è§¦å‘ | æ£€æŸ¥ç¯å¢ƒå˜é‡ `OPENCODE_DISABLE_AUTOCOMPACT` æ˜¯å¦ç”Ÿæ•ˆ |

### å‹ç¼©æ‘˜è¦è´¨é‡ä¸é«˜

Compaction Agent ä½¿ç”¨çš„ prompt æ˜¯å›ºå®šçš„ã€‚å¦‚æœä½ å‘ç°å‹ç¼©è´¨é‡ä¸å¥½ï¼š

1. **æ£€æŸ¥åŸå§‹å¯¹è¯è´¨é‡**ï¼šè¿‡äºåˆ†æ•£çš„å¯¹è¯éš¾ä»¥æ€»ç»“
2. **æ‰‹åŠ¨è¡¥å……æ‘˜è¦**ï¼šå‹ç¼©åæ‰‹åŠ¨è¾“å…¥ "æ€»ç»“è¡¥å……ï¼š..."
3. **ä½¿ç”¨ä¸åŒçš„æ¨¡å‹**ï¼šcompaction agent é»˜è®¤ä½¿ç”¨å½“å‰å¯¹è¯çš„æ¨¡å‹

### å‹ç¼©åå¿˜è®°ä¸Šä¸‹æ–‡

å‹ç¼©åçš„æ‘˜è¦è™½ç„¶è¯¦ç»†ï¼Œä½†æ— æ³•åŒ…å«æ‰€æœ‰ç»†èŠ‚ã€‚å¦‚æœä½ å‘ç°æ¨¡å‹å¿˜è®°é‡è¦ä¿¡æ¯ï¼š

1. **é‡å¯å¯¹è¯**ï¼šä»å¤´å¼€å§‹ï¼Œä½†ä¼šä¸¢å¤±æ‰€æœ‰å†å²
2. **æ‰‹åŠ¨è¡¥å……**ï¼šåœ¨å‹ç¼©åè¾“å…¥å…³é”®ä¿¡æ¯çš„æ€»ç»“
3. **è°ƒæ•´æ‘˜è¦è´¨é‡**ï¼šé€šè¿‡æ’ä»¶è¦†ç›– compaction promptï¼ˆé«˜çº§ç”¨æ³•ï¼‰

---

## æœ¬è¯¾å°ç»“

ä½ å­¦ä¼šäº†ï¼š

1. **Context ç™¾åˆ†æ¯”è®¡ç®—å…¬å¼**ï¼š`(input + output + reasoning + cache.read + cache.write) / model.limit.context * 100`
2. **è‡ªåŠ¨å‹ç¼©è§¦å‘æ¡ä»¶**ï¼š`token_count >= (input_limit - reserved)`ï¼Œå…¶ä¸­ reserved é»˜è®¤ 20,000
3. **å‹ç¼©çš„ä¸¤æ­¥æ“ä½œ**ï¼šPruneï¼ˆæ¸…é™¤æ—§å·¥å…·è¾“å‡ºï¼‰+ Summarizeï¼ˆç”Ÿæˆæ‘˜è¦ï¼‰
4. **ä¸»æµæ¨¡å‹çš„ä¸Šä¸‹æ–‡é™åˆ¶**ï¼šä» 128Kï¼ˆDeepSeek Chatï¼‰åˆ° 1Mï¼ˆGemini 3 Flashï¼‰
5. **æ§åˆ¶å‹ç¼©è¡Œä¸º**ï¼šé€šè¿‡ `compaction.auto`ã€`compaction.prune` å’Œ `compaction.reserved` é…ç½®
6. **è‡ªå®šä¹‰æ¨¡å‹é™åˆ¶**ï¼šåœ¨ `provider.models` ä¸­è¦†ç›– `limit.context` å’Œ `limit.output`
7. **v1.1.57 æ”¹è¿›**ï¼šreserve token buffer ç¡®ä¿å‹ç¼©æ›´å¯é 

---

## ä¸‹ä¸€è¯¾é¢„å‘Š

> ä¸‹ä¸€è¯¾æˆ‘ä»¬å­¦ä¹  **[5.21 æ€è€ƒæ·±åº¦é…ç½®](./21-thinking-depth)**ã€‚
>
> ä½ ä¼šå­¦åˆ°ï¼š
> - ä¸ºå•ä¸ªæ¨¡å‹è®¾ç½®æ€è€ƒé¢„ç®—
> - ç”¨å˜ä½“æœºåˆ¶æ§åˆ¶æ¨ç†æ·±åº¦
> - ç”¨ <kbd>Ctrl</kbd>+<kbd>T</kbd> å¿«é€Ÿåˆ‡æ¢

---

## é™„å½•ï¼šæºç å‚è€ƒ

<details>
<summary><strong>ç‚¹å‡»å±•å¼€æŸ¥çœ‹æºç ä½ç½®</strong></summary>

> æ›´æ–°æ—¶é—´ï¼š2026-02-14ï¼ˆv1.1.57ï¼‰

å¦‚æœä½ å¯¹å‹ç¼©æœºåˆ¶çš„å®ç°æ„Ÿå…´è¶£ï¼Œå¯ä»¥æŸ¥çœ‹æºç ï¼š

| åŠŸèƒ½ | æ–‡ä»¶è·¯å¾„ | è¡Œå· |
|-----|---------|------|
| å‹ç¼©æ ¸å¿ƒé€»è¾‘ | [`src/session/compaction.ts`](https://github.com/anomalyco/opencode/blob/dev/packages/opencode/src/session/compaction.ts) | å…¨æ–‡ä»¶ |
| è‡ªåŠ¨è§¦å‘åˆ¤æ–­ï¼ˆå« reservedï¼‰ | [`src/session/compaction.ts`](https://github.com/anomalyco/opencode/blob/dev/packages/opencode/src/session/compaction.ts#L32-L48) | 32-48 |
| Prune è£å‰ªé€»è¾‘ | [`src/session/compaction.ts`](https://github.com/anomalyco/opencode/blob/dev/packages/opencode/src/session/compaction.ts#L58-L90) | 58-90 |
| Context ç™¾åˆ†æ¯”è®¡ç®— | [`src/cli/cmd/tui/routes/session/sidebar.tsx`](https://github.com/anomalyco/opencode/blob/dev/packages/opencode/src/cli/cmd/tui/routes/session/sidebar.tsx#L51-L61) | 51-61 |
| å‹ç¼©é…ç½®é¡¹ | [`src/config/config.ts`](https://github.com/anomalyco/opencode/blob/dev/packages/opencode/src/config/config.ts#L927-L932) | 927-932 |
| æ¨¡å‹ limit Schema | [`src/provider/provider.ts`](https://github.com/anomalyco/opencode/blob/dev/packages/opencode/src/provider/provider.ts#L498-L501) | 498-501 |
| ç”¨æˆ·è‡ªå®šä¹‰ limit | [`src/provider/provider.ts`](https://github.com/anomalyco/opencode/blob/dev/packages/opencode/src/provider/provider.ts#L722-L724) | 722-724 |
| Compaction Agent | [`src/agent/agent.ts`](https://github.com/anomalyco/opencode/blob/dev/packages/opencode/src/agent/agent.ts#L122-L136) | 122-136 |
| Compaction Prompt | [`src/agent/prompt/compaction.txt`](https://github.com/anomalyco/opencode/blob/dev/packages/opencode/src/agent/prompt/compaction.txt) | å…¨æ–‡ä»¶ |

**å…³é”®å¸¸é‡**ï¼š
- `COMPACTION_BUFFER = 20,000`ï¼šé»˜è®¤é¢„ç•™ç©ºé—´ï¼ˆv1.1.57 æ–°å¢ï¼‰
- `PRUNE_PROTECT = 40,000`ï¼šä¿æŠ¤æœ€è¿‘ 40K tokens çš„å·¥å…·è¾“å‡º
- `PRUNE_MINIMUM = 20,000`ï¼šæœ€å°è£å‰ªé˜ˆå€¼

</details>
