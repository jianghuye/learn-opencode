# 5.22 è°ƒè¯•ä¸è¯Šæ–­å·¥å…·

> åƒå¼€å‘è€…ä¸€æ ·å‰–æ OpenCode

## ğŸ“ è¯¾ç¨‹ç¬”è®°

æœ¬è¯¾æ ¸å¿ƒçŸ¥è¯†ç‚¹æ•´ç†ï¼š

<img src="/images/5-advanced/22-debugging-notes.mini.jpeg"
     alt="è°ƒè¯•ä¸è¯Šæ–­å·¥å…·å­¦éœ¸ç¬”è®°"
     data-zoom-src="/images/5-advanced/22-debugging-notes.jpeg" />

---

## ğŸ’ å¼€å§‹å‰çš„å‡†å¤‡

- äº†è§£å‘½ä»¤è¡ŒåŸºæœ¬æ“ä½œ
- é‡åˆ°è¿‡éš¾ä»¥æ’æŸ¥çš„ Bug æˆ–é…ç½®é—®é¢˜

## æ ¸å¿ƒæ€è·¯

OpenCode å†…ç½®äº†ä¸€å¥—å¼ºå¤§çš„è°ƒè¯•å·¥å…·ç®± `opencode debug`ã€‚è¿™äº›å·¥å…·ä¸ä»…ç”¨äºå¼€å‘è°ƒè¯•ï¼Œä¹Ÿèƒ½å¸®åŠ©é«˜çº§ç”¨æˆ·è¯Šæ–­é…ç½®é”™è¯¯ã€æ–‡ä»¶ç³»ç»Ÿé—®é¢˜å’Œ AI è¡Œä¸ºå¼‚å¸¸ã€‚

## è·Ÿæˆ‘åš

### 1. è°ƒè¯•é…ç½® (Config)

æƒ³çŸ¥é“ä½ çš„é…ç½®åˆ°åº•æ€ä¹ˆç”Ÿæ•ˆçš„ï¼Ÿ

**é‡è¦åœºæ™¯**ï¼šOpenCode çš„é…ç½®ä¸ä»…æ¥è‡ª `opencode.json`ï¼Œ**æ’ä»¶ä¹Ÿå¯ä»¥åœ¨å¯åŠ¨æ—¶åŠ¨æ€æ³¨å…¥é…ç½®**ã€‚

å¦‚æœä½ æƒ³ç¡®è®¤ï¼š
- æŸä¸ªæ’ä»¶æ³¨å…¥çš„é…ç½®æ˜¯å¦ç”Ÿæ•ˆï¼Ÿ
- é»˜è®¤å€¼ã€ç”¨æˆ·é…ç½®å’Œæ’ä»¶é…ç½®åˆå¹¶åçš„**æœ€ç»ˆç»“æœ**æ˜¯ä»€ä¹ˆï¼Ÿ

å¿…é¡»ä½¿ç”¨æ­¤å‘½ä»¤ï¼š

```bash
opencode debug config
```

**è¾“å‡ºç¤ºä¾‹**ï¼ˆæˆªå–ï¼‰ï¼š
```json
{
  "$schema": "https://opencode.ai/config.json",
  "keybinds": { ... },
  // è¿™é‡Œåˆ—å‡ºäº†æ‰€æœ‰å·²åŠ è½½çš„ Agentï¼ˆåŒ…æ‹¬é»˜è®¤å’Œè‡ªå®šä¹‰ï¼‰
  "agent": {
    "coder": { ... },
    "writer": { ... },
    "my-custom-agent": { ... } // ç¡®è®¤è‡ªå®šä¹‰ Agent æ˜¯å¦å­˜åœ¨
  },
  // è¿™é‡Œå¯èƒ½åŒ…å«æ’ä»¶åŠ¨æ€æ³¨å…¥çš„é…ç½®
  "plugin_injected_config": { ... }
}
```

::: tip ğŸ’¡ æ€ä¹ˆçœ‹åŠ è½½äº†å“ªäº› Agentï¼Ÿ
ç›´æ¥çœ‹ `opencode debug config` è¾“å‡ºä¸­çš„ `agent` å­—æ®µã€‚è¿™é‡Œåˆ—å‡ºäº†æ‰€æœ‰**å·²æ³¨å†Œä¸”å¯ç”¨**çš„ Agentã€‚
å¦‚æœè¿™é‡Œæ²¡æœ‰ï¼Œè¯´æ˜ Agent å®šä¹‰æ–‡ä»¶æœ‰é—®é¢˜ï¼Œæˆ–è€…æ²¡è¢« OpenCode æ‰«æåˆ°ã€‚
:::

### 2. è°ƒè¯•æ–‡ä»¶ç³»ç»Ÿ (File & Ripgrep)

OpenCode ä¾èµ– ripgrep è¿›è¡Œæé€Ÿæœç´¢ã€‚å¦‚æœæœç´¢ç»“æœä¸ç¬¦åˆé¢„æœŸï¼Œå¯ä»¥ç”¨è¿™äº›å‘½ä»¤æ’æŸ¥ã€‚

**æ£€æŸ¥æœç´¢åº•å±‚è¡Œä¸º**ï¼š
```bash
# æµ‹è¯•æœç´¢
opencode debug rg search "å…³é”®è¯"

# æŸ¥çœ‹æ–‡ä»¶æ ‘ï¼ˆOpenCode çœ¼ä¸­çš„ç›®å½•ç»“æ„ï¼‰
opencode debug rg tree
```

**æ£€æŸ¥æ–‡ä»¶è¯»å–**ï¼š
```bash
# è¯»å–æ–‡ä»¶å†…å®¹ï¼ˆä»¥ JSON æ ¼å¼ï¼ŒåŒ…å«å…ƒæ•°æ®ï¼‰
opencode debug file read package.json
```

### 3. è°ƒè¯• Agent å’Œ Skill

å½“ä½ å®‰è£…äº†å¤§é‡æ’ä»¶æˆ–æ‰‹åŠ¨æ·»åŠ äº†å¾ˆå¤š Skill æ—¶ï¼Œå¯èƒ½ä¼šé‡åˆ°**"æˆ‘è£…äº†ä½†ä¸çŸ¥é“ç”Ÿæ•ˆæ²¡"**çš„æƒ…å†µã€‚

**ç”¨äº†ä¸‹é¢è¿™ä¸ªå‘½ä»¤ï¼Œå°±èƒ½å¿«é€ŸçŸ¥é“ OpenCode ç°åœ¨å®é™…åŠ è½½äº†å“ªäº› Skill**ã€‚å®ƒä¼šåˆ—å‡º Skill çš„åç§°å’Œç‰©ç†è·¯å¾„ï¼Œæ˜¯æ’æŸ¥å†²çªçš„ç»ˆææ‰‹æ®µã€‚

**åˆ—å‡ºå®é™…åŠ è½½çš„ Skill**ï¼š
```bash
opencode debug skill
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```json
[
  {
    "name": "fanyi",
    "description": "...",
    // ç¡®è®¤åŠ è½½çš„æ˜¯å“ªä¸ªè·¯å¾„ä¸‹çš„æ–‡ä»¶
    "location": "/Users/user/.claude/skills/fanyi/SKILL.md"
  },
  {
    "name": "sync-changelog",
    // ç¡®è®¤æ˜¯å¦è¦†ç›–äº†åŒå Skill
    "location": "/Users/user/.config/opencode/skill/sync-changelog/SKILL.md"
  }
]
```

**æŸ¥çœ‹ Agent é…ç½®è¯¦æƒ…**ï¼š
```bash
# æŸ¥çœ‹ audit-gemini çš„å®Œæ•´é…ç½®ï¼ˆå«æƒé™ã€Promptï¼‰
opencode debug agent audit-gemini
```

**[é«˜é˜¶] æ‰‹åŠ¨æ‰§è¡Œ Agent å·¥å…·**ï¼š
æƒ³æµ‹è¯• Agent èƒ½å¦æˆåŠŸè°ƒç”¨æŸä¸ªå·¥å…·ï¼Ÿå¯ä»¥ç›´æ¥æµ‹è¯•ï¼š

```bash
# æµ‹è¯• audit-gemini ä½¿ç”¨ bash å·¥å…·
opencode debug agent audit-gemini --tool bash --params '{"command":"ls -la"}'
```

**åˆ—å‡ºæ‰€æœ‰ Skill**ï¼š
```bash
opencode debug skill
```

### 4. è°ƒè¯• LSP (è¯­è¨€æœåŠ¡å™¨)

å¦‚æœä»£ç è¡¥å…¨ã€è·³è½¬å®šä¹‰ä¸å·¥ä½œï¼Œå¯èƒ½æ˜¯ LSP å‡ºäº†é—®é¢˜ã€‚

```bash
# è·å–æ–‡ä»¶çš„è¯Šæ–­ä¿¡æ¯ï¼ˆæŠ¥é”™/è­¦å‘Šï¼‰
opencode debug lsp diagnostics src/index.ts

# æœç´¢å·¥ä½œåŒºç¬¦å·
opencode debug lsp symbols "AppController"

# è·å–å•ä¸ªæ–‡ä»¶çš„ç¬¦å·ç»“æ„
opencode debug lsp document-symbols src/index.ts
```

### 5. æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€ (Paths & Scrap)

**æŸ¥çœ‹å…³é”®è·¯å¾„**ï¼š
ä¸çŸ¥é“æ•°æ®å­˜åœ¨å“ªï¼Ÿ
```bash
opencode debug paths
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
data       /Users/username/.local/share/opencode
config     /Users/username/.config/opencode
log        /Users/username/.local/share/opencode/log
cache      /Users/username/.cache/opencode
```

**æŸ¥çœ‹é¡¹ç›®å†å² (Scrap)**ï¼š
OpenCode ä¼šè®°å½•ä½ æ‰“å¼€è¿‡çš„æ‰€æœ‰é¡¹ç›®ï¼ˆWorktreeï¼‰ã€‚
```bash
opencode debug scrap
```

### 6. è°ƒè¯•å¿«ç…§ (Snapshot)

OpenCode çš„ä¸Šä¸‹æ–‡å‹ç¼©ä¾èµ–å¿«ç…§æœºåˆ¶ã€‚

```bash
# è¿½è¸ªå½“å‰å¿«ç…§çŠ¶æ€
opencode debug snapshot track

# æŸ¥çœ‹å¿«ç…§å·®å¼‚
opencode debug snapshot diff <hash>
```

## å‘½ä»¤é€ŸæŸ¥è¡¨

| å‘½ä»¤ | ç”¨é€” | å…¸å‹åœºæ™¯ |
|------|------|----------|
| `debug config` | æŸ¥çœ‹æœ€ç»ˆé…ç½® | æ£€æŸ¥é…ç½®æ˜¯å¦ç”Ÿæ•ˆã€æŸ¥çœ‹é»˜è®¤å¿«æ·é”® |
| `debug agent <name>` | æŸ¥çœ‹ Agent è¯¦æƒ… | æ£€æŸ¥ Promptã€æƒé™ã€å·¥å…·åˆ—è¡¨ |
| `debug agent --tool` | **æ‰‹åŠ¨æ‰§è¡Œå·¥å…·** | éªŒè¯å·¥å…·å‚æ•°æ ¼å¼ã€æµ‹è¯•å·¥å…·æƒé™ |
| `debug skill` | åˆ—å‡º Skill | ç¡®è®¤ Skill æ˜¯å¦åŠ è½½ã€æŸ¥çœ‹åŠ è½½è·¯å¾„ |
| `debug rg search` | æµ‹è¯•æœç´¢ | æ’æŸ¥æœç´¢ä¸åˆ°æ–‡ä»¶çš„é—®é¢˜ |
| `debug file read` | è¯»å–æ–‡ä»¶ | æ£€æŸ¥æ–‡ä»¶å†…å®¹è¯»å–æ˜¯å¦åŒ…å«å…ƒæ•°æ® |
| `debug file status` | æ–‡ä»¶çŠ¶æ€ | æŸ¥çœ‹ Git çŠ¶æ€é›†æˆ |
| `debug paths` | æŸ¥çœ‹è·¯å¾„ | æ‰¾æ—¥å¿—æ–‡ä»¶ã€æ¸…ç©ºç¼“å­˜æ—¶ç¡®è®¤è·¯å¾„ |
| `debug lsp` | è°ƒè¯• LSP | æ’æŸ¥ä»£ç è¡¥å…¨/è·³è½¬å¤±æ•ˆé—®é¢˜ |
| `debug scrap` | æŸ¥çœ‹é¡¹ç›®åˆ—è¡¨ | æ‰¾å›å†å²é¡¹ç›® ID |

## è¸©å‘æé†’

| ç°è±¡ | åŸå›  | è§£å†³ |
|------|------|------|
| `command not found` | æ—§ç‰ˆæœ¬ OpenCode | å‡çº§åˆ°æœ€æ–°ç‰ˆ |
| è¾“å‡ºå†…å®¹è¿‡å¤š | JSON æ•°æ®é‡å¤§ | é…åˆ `> debug.txt` é‡å®šå‘åˆ°æ–‡ä»¶æŸ¥çœ‹ |
| `debug agent` æŠ¥é”™ | æœªæŒ‡å®š Agent åç§° | å¿…é¡»åŠ åå­—ï¼Œå¦‚ `opencode debug agent coder` |

## æœ¬è¯¾å°ç»“

`opencode debug` å‘½ä»¤çš„æ ¸å¿ƒä»·å€¼åœ¨äº**"è¿è¡Œæ—¶å¯è§æ€§"**ï¼š

1.  **Config**: çœ‹åˆ°çš„æ˜¯æ’ä»¶æ³¨å…¥å¹¶åˆå¹¶åçš„**æœ€ç»ˆé…ç½®**ï¼Œè€Œéé™æ€æ–‡ä»¶ã€‚
2.  **Skill**: çœ‹åˆ°çš„æ˜¯**å®é™…åŠ è½½**çš„æ¸…å•å’Œè·¯å¾„ï¼Œç¡®è®¤æ²¡æœ‰è¢«å¿½ç•¥æˆ–è¦†ç›–ã€‚
3.  **Agent**: çœ‹åˆ°çš„æ˜¯å®Œæ•´çš„ä¸Šä¸‹æ–‡å’Œæƒé™ï¼Œç”šè‡³å¯ä»¥æ¨¡æ‹Ÿæ‰§è¡Œã€‚

å½“ä½ æ€€ç–‘ OpenCode "åäº†"çš„æ—¶å€™ï¼Œå…ˆç”¨è¿™äº›å‘½ä»¤ç…§ä¸€ç…§ï¼Œé€šå¸¸èƒ½å‘ç°æ˜¯é…ç½®é—®é¢˜è¿˜æ˜¯çœŸçš„ Bugã€‚
